{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Parameters": {
        "OrchestratorPlatformUrl": {
            "Type": "String",
            "Default": "https://platform.uipath.com/",
            "Description": "Orchestrator Platform Url"
        },
        "OrchestratorAuthUrl": {
            "Type": "String",
            "Default": "https://account.uipath.com/oauth/token"
        },
        "OrchestratorApiAccessUserKey": {
            "Type": "String"
        },
        "OrchestratorAccountName": {
            "Type": "String"
        },
        "OrchestratorApiAccessClientId": {
            "Type": "String"
        },
        "OrchestratorTenantLogicalName": {
            "Type": "String"
        },
        "S3BucketNameForContactFlows": {
            "Type": "String"
        }
    },
    "Metadata": {
        "AWS::CloudFormation::Interface": {
            "ParameterGroups": [
                {
                    "Label": {
                        "default": "Orchestrator URLs"
                    },
                    "Parameters": [
                        "OrchestratorPlatformUrl",
                        "OrchestratorAuthUrl"
                    ]
                },
                {
                    "Label": {
                        "default": "Orchestrator API Access"
                    },
                    "Parameters": [
                        "OrchestratorApiAccessUserKey",
                        "OrchestratorAccountName",
                        "OrchestratorTenantLogicalName",
                        "OrchestratorApiAccessClientId"
                    ]
                },
                {
                    "Label": {
                        "default": "Contact Flows S3 bucket details"
                    },
                    "Parameters": [
                        "S3BucketNameForContactFlows"
                    ]
                }
            ],
            "ParameterLabels": {
                "OrchestratorPlatformUrl": {
                    "default": "Platform URL"
                },
                "OrchestratorAuthUrl": {
                    "default": "Account Authentication URL"
                },
                "OrchestratorApiAccessUserKey": {
                    "default": "User Key"
                },
                "OrchestratorAccountName": {
                    "default": "Account Name"
                },
                "OrchestratorApiAccessClientId": {
                    "default": "Client Id"
                },
                "OrchestratorTenantLogicalName": {
                    "default": "Tenant Logical Name"
                },
                "S3BucketNameForContactFlows": {
                    "default": "S3 Bucket for saving Contact Flows"
                }
            }
        },
        "AWS::CloudFormation::Designer": {
            "68532bb8-9617-4031-b4f0-672dc48df5e2": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 770,
                    "y": 360
                },
                "z": 1,
                "embeds": []
            },
            "c973d49f-73fa-4a7b-856d-9308c9a68249": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 770,
                    "y": 280
                },
                "z": 1,
                "embeds": []
            },
            "9e1d4126-ce88-46f7-bdeb-c249df1db9b6": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 770,
                    "y": 200
                },
                "z": 1,
                "embeds": []
            },
            "5ecd6b2e-3913-42c9-9925-fc0c0d76cd32": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 680,
                    "y": 100
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "750c790d-cd4b-49ed-82f3-44dcfc0d279f"
                ]
            },
            "e161f4a4-b911-4561-81eb-d877bfb93ab1": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 690,
                    "y": 440
                },
                "z": 1,
                "embeds": []
            },
            "8dc3c699-7f61-4e13-8507-0ff656a7c7da": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 840,
                    "y": 440
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "68532bb8-9617-4031-b4f0-672dc48df5e2"
                ]
            },
            "f1829e81-1bf1-44f9-a4da-b40a9d779462": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 850,
                    "y": 100
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "5ecd6b2e-3913-42c9-9925-fc0c0d76cd32",
                    "e2533b58-79da-42d4-968a-66b0f79e0fc7"
                ]
            },
            "526514f8-0a7c-4067-95e3-5e1eec404e08": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 680,
                    "y": -120
                },
                "z": 1,
                "embeds": []
            },
            "750c790d-cd4b-49ed-82f3-44dcfc0d279f": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 680,
                    "y": -10
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "526514f8-0a7c-4067-95e3-5e1eec404e08"
                ]
            },
            "c991bd67-03c2-4323-b884-83787196290a": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 950,
                    "y": -10
                },
                "z": 0,
                "embeds": [],
                "dependson": [
                    "f1829e81-1bf1-44f9-a4da-b40a9d779462"
                ]
            },
            "e2533b58-79da-42d4-968a-66b0f79e0fc7": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 850,
                    "y": -10
                },
                "z": 0,
                "embeds": [],
                "dependson": [
                    "f1829e81-1bf1-44f9-a4da-b40a9d779462"
                ]
            },
            "786cac24-4cf6-4769-9937-1737ce29b296": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 1050,
                    "y": 360
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "c991bd67-03c2-4323-b884-83787196290a",
                    "e2533b58-79da-42d4-968a-66b0f79e0fc7"
                ]
            },
            "0ff23925-2dc6-4df1-90aa-22839618575d": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 1190,
                    "y": 360
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "786cac24-4cf6-4769-9937-1737ce29b296"
                ]
            },
            "d203d625-ae0d-4f49-adf0-7148bd717a27": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 1290,
                    "y": 360
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "786cac24-4cf6-4769-9937-1737ce29b296",
                    "0ff23925-2dc6-4df1-90aa-22839618575d",
                    "963f9244-5ed0-42ff-a750-916edd82443a"
                ]
            },
            "b76720dc-cc59-4020-b510-86a490cde578": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 1290,
                    "y": 260
                },
                "z": 0,
                "embeds": []
            },
            "963f9244-5ed0-42ff-a750-916edd82443a": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 1410,
                    "y": 260
                },
                "z": 0,
                "embeds": [],
                "dependson": [
                    "b76720dc-cc59-4020-b510-86a490cde578"
                ]
            },
            "99a36e59-a036-44f0-9678-b88f19422dff": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 1410,
                    "y": 360
                },
                "z": 1,
                "embeds": [],
                "dependson": [
                    "c991bd67-03c2-4323-b884-83787196290a",
                    "e2533b58-79da-42d4-968a-66b0f79e0fc7"
                ]
            },
            "85e8dd97-e0f5-441d-80d7-3cfdd0e00ebb": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 1190,
                    "y": 260
                },
                "z": 0,
                "embeds": []
            },
            "60a391b9-db7b-40a4-b70d-48bb31bb02fa": {
                "source": {
                    "id": "0ff23925-2dc6-4df1-90aa-22839618575d"
                },
                "target": {
                    "id": "85e8dd97-e0f5-441d-80d7-3cfdd0e00ebb"
                },
                "z": 11
            }
        }
    },
    "Resources": {
        "UiPathClientId": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Description": "Client Id for API access for UiPath Orchestrator",
                "SecretString": {
                    "Ref": "OrchestratorApiAccessClientId"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "526514f8-0a7c-4067-95e3-5e1eec404e08"
                }
            }
        },
        "UiPathUserKey": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Description": "User Key for API access for UiPath Orchestrator",
                "SecretString": {
                    "Ref": "OrchestratorApiAccessUserKey"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "750c790d-cd4b-49ed-82f3-44dcfc0d279f"
                }
            },
            "DependsOn": [
                "UiPathClientId"
            ]
        },
        "UiPathAccessToken": {
            "Type": "AWS::SecretsManager::Secret",
            "Properties": {
                "Description": "User Key for API access for UiPath Orchestrator",
                "SecretString": "init access token"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "5ecd6b2e-3913-42c9-9925-fc0c0d76cd32"
                }
            },
            "DependsOn": [
                "UiPathUserKey"
            ]
        },
        "UiPathAuthenticatePermissions": {
            "Type": "AWS::Lambda::Permission",
            "Properties": {
                "FunctionName": {
                    "Ref": "UiPathAuthenticate"
                },
                "Action": "lambda:InvokeFunction",
                "Principal": "events.amazonaws.com",
                "SourceArn": {
                    "Fn::GetAtt": [
                        "UiPathAuthenticateScheduledRule",
                        "Arn"
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "8dc3c699-7f61-4e13-8507-0ff656a7c7da"
                }
            }
        },
        "UiPathAuthenticate": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": "uipath-contact-center",
                    "S3Key": "UiPathContactCenterAuthenticate.zip"
                },
                "Handler": "index.handler",
                "Runtime": "nodejs12.x",
                "MemorySize": 256,
                "Timeout": 30,
                "Role": {
                    "Fn::GetAtt": [
                        "UiPathAllowLoggingAndSecretManagerRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "api_access_auth_url": {
                            "Ref": "OrchestratorAuthUrl"
                        },
                        "api_access_key_client_id_secret_id": {
                            "Ref": "UiPathClientId"
                        },
                        "api_access_key_user_key_secret_id": {
                            "Ref": "UiPathUserKey"
                        },
                        "access_token_secret_id": {
                            "Ref": "UiPathAccessToken"
                        }
                    }
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "68532bb8-9617-4031-b4f0-672dc48df5e2"
                }
            },
            "DependsOn": [
                "UiPathAllowLoggingAndSecretManagerRole"
            ]
        },
        "UiPathStartJob": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": "uipath-contact-center",
                    "S3Key": "UiPathContactCenterStartJob.zip"
                },
                "Handler": "index.handler",
                "Runtime": "nodejs12.x",
                "MemorySize": 256,
                "Timeout": 30,
                "Role": {
                    "Fn::GetAtt": [
                        "UiPathAllowLoggingAndSecretManagerRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "platformUrl": {
                            "Ref": "OrchestratorPlatformUrl"
                        },
                        "accountName": {
                            "Ref": "OrchestratorAccountName"
                        },
                        "tenantName": {
                            "Ref": "OrchestratorTenantLogicalName"
                        },
                        "access_token_secret_id": {
                            "Ref": "UiPathAccessToken"
                        }
                    }
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "9e1d4126-ce88-46f7-bdeb-c249df1db9b6"
                }
            },
            "DependsOn": [
                "UiPathAllowLoggingAndSecretManagerRole"
            ]
        },
        "UiPathQueryJob": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": "uipath-contact-center",
                    "S3Key": "UiPathContactCenterQueryJob.zip"
                },
                "Handler": "index.handler",
                "Runtime": "nodejs12.x",
                "MemorySize": 256,
                "Timeout": 30,
                "Role": {
                    "Fn::GetAtt": [
                        "UiPathAllowLoggingAndSecretManagerRole",
                        "Arn"
                    ]
                },
                "Environment": {
                    "Variables": {
                        "platformUrl": {
                            "Ref": "OrchestratorPlatformUrl"
                        },
                        "accountName": {
                            "Ref": "OrchestratorAccountName"
                        },
                        "tenantName": {
                            "Ref": "OrchestratorTenantLogicalName"
                        },
                        "access_token_secret_id": {
                            "Ref": "UiPathAccessToken"
                        }
                    }
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "c973d49f-73fa-4a7b-856d-9308c9a68249"
                }
            },
            "DependsOn": [
                "UiPathAllowLoggingAndSecretManagerRole"
            ]
        },
        "UiPathAuthenticateScheduledRule": {
            "Type": "AWS::Events::Rule",
            "Properties": {
                "Description": "ScheduledRule",
                "ScheduleExpression": "rate(50 minutes)",
                "State": "ENABLED",
                "Targets": [
                    {
                        "Arn": {
                            "Fn::GetAtt": [
                                "UiPathAuthenticate",
                                "Arn"
                            ]
                        },
                        "Id": "TargetUiPathOrchestratorAuthenticate"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "e161f4a4-b911-4561-81eb-d877bfb93ab1"
                }
            },
            "DependsOn": [
                "UiPathAuthenticate"
            ]
        },
        "UiPathAllowLoggingAndSecretManagerRole": {
            "Type": "AWS::IAM::Role",
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "f1829e81-1bf1-44f9-a4da-b40a9d779462"
                }
            },
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Description": "Role for adding permissions for logging and secret manager"
            },
            "DependsOn": []
        },
        "UiPathAllowLoggingPolicy": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "UiPathAllowLoggingPolicy",
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "logs:CreateLogGroup",
                                "logs:CreateLogStream",
                                "logs:PutLogEvents"
                            ],
                            "Resource": "arn:aws:logs:*:*:*"
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "UiPathAllowLoggingAndSecretManagerRole"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "c991bd67-03c2-4323-b884-83787196290a"
                }
            },
            "DependsOn": [
                "UiPathAllowLoggingAndSecretManagerRole"
            ]
        },
        "UiPathSecretManagerPolicy": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "UiPathSecretManagerPolicy",
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "secretsmanager:GetSecretValue",
                                "secretsmanager:PutSecretValue",
                                "secretsmanager:UpdateSecret"
                            ],
                            "Resource": [
                                {
                                    "Ref": "UiPathClientId"
                                },
                                {
                                    "Ref": "UiPathUserKey"
                                },
                                {
                                    "Ref": "UiPathAccessToken"
                                }
                            ]
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "UiPathAllowLoggingAndSecretManagerRole"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "e2533b58-79da-42d4-968a-66b0f79e0fc7"
                }
            },
            "DependsOn": [
                "UiPathAllowLoggingAndSecretManagerRole"
            ]
        },
        "InvokeAuthenticate": {
            "Type": "Custom::UiPathAuthenticate",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "UiPathAuthenticate",
                        "Arn"
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "786cac24-4cf6-4769-9937-1737ce29b296"
                }
            },
            "DependsOn": [
                "UiPathAllowLoggingPolicy",
                "UiPathSecretManagerPolicy",
                "UiPathAuthenticate"
            ]
        },
        "UiPathPackInputs": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": "uipath-contact-center",
                    "S3Key": "UiPathContactCenterPackInputs.zip"
                },
                "Handler": "index.handler",
                "Runtime": "nodejs12.x",
                "MemorySize": 256,
                "Timeout": 30,
                "Role": {
                    "Fn::GetAtt": [
                        "UiPathAllowLoggingRole",
                        "Arn"
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "0ff23925-2dc6-4df1-90aa-22839618575d"
                }
            },
            "DependsOn": [
                "InvokeAuthenticate",
                "UiPathAllowLoggingRole"
            ]
        },
        "UiPathAllowS3WritePolicy": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "UiPathAllowS3WritePolicy",
                "PolicyDocument": {
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": [
                                "s3:PutObject"
                            ],
                            "Resource": "*"
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "UiPathAllowS3WriteRole"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "963f9244-5ed0-42ff-a750-916edd82443a"
                }
            },
            "DependsOn": [
                "UiPathAllowS3WriteRole"
            ]
        },
        "UiPathAllowS3WriteRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "b76720dc-cc59-4020-b510-86a490cde578"
                }
            }
        },
        "UiPathCreateContactFlows": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": "uipath-contact-center",
                    "S3Key": "UiPathCreateContactFlows.zip"
                },
                "Handler": "index.handler",
                "Runtime": "nodejs12.x",
                "MemorySize": 256,
                "Timeout": 30,
                "Role": {
                    "Fn::GetAtt": [
                        "UiPathAllowS3WriteRole",
                        "Arn"
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "d203d625-ae0d-4f49-adf0-7148bd717a27"
                }
            },
            "DependsOn": [
                "InvokeAuthenticate",
                "UiPathPackInputs",
                "UiPathAllowS3WritePolicy"
            ]
        },
        "InvokeCreateContactFlows": {
            "Type": "Custom::UiPathCreateContactFlows",
            "Properties": {
                "ServiceToken": {
                    "Fn::GetAtt": [
                        "UiPathCreateContactFlows",
                        "Arn"
                    ]
                },
                "bucketName": {
                    "Ref": "S3BucketNameForContactFlows"
                },
                "CreateInputParamsLambdaArn": {
                    "Fn::GetAtt": [
                        "UiPathPackInputs",
                        "Arn"
                    ]
                },
                "StartJobLambdaArn": {
                    "Fn::GetAtt": [
                        "UiPathStartJob",
                        "Arn"
                    ]
                },
                "QueryJobLambdaArn": {
                    "Fn::GetAtt": [
                        "UiPathQueryJob",
                        "Arn"
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "99a36e59-a036-44f0-9678-b88f19422dff"
                }
            },
            "DependsOn": [
                "UiPathCreateContactFlows"
            ]
        },
        "UiPathAllowLoggingRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "lambda.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "85e8dd97-e0f5-441d-80d7-3cfdd0e00ebb"
                }
            }
        }
    }
}